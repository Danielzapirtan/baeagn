name: ZX Basic with z88dk
on: [push, pull_request]

jobs:
  run-basic:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Install z88dk and fuse
        run: |
          sudo apt-get update
          sudo apt-get install -y z88dk fuse-emulator-gtk spectrum-roms
          
      - name: Create and compile Basic program
        run: |
          # Create Basic program
          cat > chess.bas << 'EOF'
          10 REM Chess Engine
          20 PRINT "Engine v1.0"
          30 PRINT "Position loaded"
          40 FOR i=1 TO 500: NEXT i
          50 PRINT "Best: e4"
          60 PRINT "Score: +0.2"
          70 STOP
          EOF
          
          # Convert using z88dk's bas2tap equivalent
          zxbas -a chess.bas chess.tap
          # If zxbas isn't available, use this alternative:
          if ! command -v zxbas &> /dev/null; then
            echo "Using manual tape creation..."
            # Create a simple loader that types the program in
            cat > loader.bas << 'LOADER'
          10 CLEAR 29999
          20 LOAD "" CODE
          30 PRINT "Running..."
          40 RANDOMIZE USR 30000
          LOADER
            appmake +zx --bin --org 30000 -o chess.bin chess.bas
          fi
          
      - name: Run program
        run: |
          echo "=== Output ==="
          timeout 10s fuse --tape chess.tap --machine 48 --auto-load --interface none 2>&1 | grep -v "^Fuse:" | tee output.log