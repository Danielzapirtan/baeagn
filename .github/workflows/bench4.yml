name: Test ZX Spectrum BASIC

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y python3 python3-pip
        # Install Fuse (Free Unix Spectrum Emulator)
        sudo apt-get install -y fuse-emulator-sdl
        # Install bas2tap for BASIC to TAP conversion
        pip3 install bas2tap
    
    - name: Convert BASIC to TAP
      run: |
        # Convert your BASIC text file to TAP format
        bas2tap -a 10 -s "Program" program.bas program.tap
        # -a 10: autostart at line 10
        # -s "Program": program name
    
    - name: Run in emulator
      run: |
        # Run the program in headless mode and capture output
        # This creates a screenshot after execution
        fuse --no-sound --tape program.tap \
             --auto-load \
             --screenshot screenshot.png \
             --graphics-filter none \
             2>&1 | tee output.log
    
    - name: Verify output
      run: |
        # Check if the program ran successfully
        # You can add custom validation here
        if grep -q "ERROR" output.log; then
          echo "Program encountered an error"
          exit 1
        fi
        echo "Program executed successfully"
    
    - name: Upload artifacts
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: test-results
        path: |
          screenshot.png
          output.log
          program.tap